<!DOCTYPE html>

<html>
    <head>
        <title>Atom Test</title>
        <meta charset='utf-8' /> 
        <script src='atom.js'></script>
        <style>
            .atom_name {
            }
            .payload {
                color: #b0b0b0;
            }
        </style>
        <script>
            
            function init() {
                console.log('init');
                
                var content = document.getElementById('content');
                var load = function() {
                    var parser = new ATOM.Parser(this.response);
                    var result = parser.parse();
                    result.enumerate(function(name, payload, level) {
                        var indent = '';
                        for (var i = 0; i < level; i++) {
                            indent += '  ';
                        }
                        content.innerHTML += indent + '<span class="atom_name">' + name + '</span><br>';
                        if (payload) {
                            content.innerHTML += indent + '<span class="payload">' + JSON.stringify(payload) + '</span><br>';
                        }
                    });
                    
                    
                    //
                    // https://developer.apple.com/library/content/documentation/QuickTime/QTFF/QTFFChap2/qtff2.html
                    //
                    
                    console.log(result);
                    
                    //var timeScale = result.get('moov.mvhd.timeScale.value');
                    //console.log(timeScale);
                    
                    var track = 0;
                    while (true) {
                        
                        // Get track
                        console.log('** Track ' + track);
                        var trak = result.get('moov.trak[' + track + ']');
                        if (!trak) {
                            break;
                        }
                        
                        // Get time scale
                        var mediaHeader = trak.mdia.mdhd;
                        var timeScale = mediaHeader.timeScale.value;
                        console.log('Time scale: ' + timeScale);
                        
                        // Get sample table + show sample format
                        var sampleTable = trak.mdia.minf.stbl;
                        var sampleDescriptionTable = sampleTable.stsd.sampleDescriptionTable.value;
                        for (var i = 0; i < sampleDescriptionTable.length; i++) {
                            var format = sampleDescriptionTable[i].dataFormat.decodedValue;
                            console.log('Format: ' + format);
                        }
                        
                        // Get time-to-sample table
                        var timeToSampleTable = sampleTable.stts.timeToSampleTable.value;
                        var combinedDuration = 0;
                        var totalSampleCount = 0;
                        for (var i = 0; i < timeToSampleTable.length; i++) {
                            combinedDuration += 
                                timeToSampleTable[i].sampleCount.value * 
                                timeToSampleTable[i].sampleDuration.value;
                            totalSampleCount += timeToSampleTable[i].sampleCount.value;
                        }
                        console.log('Combined duration: ' + (combinedDuration / timeScale).toFixed(2) + ' seconds, total samples: ' + totalSampleCount);
                        
                        // Get sample-to-chunk table
                        var sampleToChunkTable = sampleTable.stsc.sampleToChunkTable.value;
                        var totalSampleCount2 = 0;
                        for (var i = 0; i < sampleToChunkTable.length - 1; i++) {
                            var a = sampleToChunkTable[i];
                            var b = sampleToChunkTable[i + 1];
                            
                            var chunkDelta = b.firstChunk.value - a.firstChunk.value;
                            totalSampleCount2 += chunkDelta * a.samplesPerChunk.value;
                        }
                        console.log('Total samples: ' + totalSampleCount2);
                        
                        // Get chunk offset table
                        var chunkOffsetTable = sampleTable.stco.chunkOffsetTable.value;
                        var firstChunkOffset = chunkOffsetTable[0];
                        
                        // Get sample-size table
                        var sampleSizeTable = sampleTable.stsz.sampleSizeTable.value;
                        console.log(sampleSizeTable);
                        
                        
                        var reader = new ATOM.Reader(this.response);
                        reader.seek(firstChunkOffset);
                        
                        
                        
                        
                        
                        
                        track++;
                    }
                }
                
                var req = new XMLHttpRequest();
                req.responseType = 'arraybuffer';
                req.addEventListener('load', load);
                req.open('get', 'video.mov');
                req.send();
            }
        
        </script>
    </head>
    <body onload='init()'>
        <pre id='content'></pre>
    </body>
</html>